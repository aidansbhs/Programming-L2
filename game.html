<!doctype html>

<html>

</html>

<body>
    <style>
        canvas {
            padding-left: 0;
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            margin-top: 15vh;
            display: block;
        }

    </style>

    <canvas id="gameCanvas" width="800" height="575"></canvas>
    <script>
        var canvas, ctx;

        var ball;

        window.onload = function() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
         imageAssets = loadImages();

            setInterval(mainloop, 1000 / 50);

            ball = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                radius: 15,
                status: 0
            }; //ball size and starting position

            document.addEventListener('keydown', keyPressed);
            document.addEventListener('keyup', keyReleased);
        }

        //player movement

        //player 1
        var playerXpos = 0;
        var playerYpos = 0;
        const PLAYER_SIZE = 40;
        var playerXspeed = 3.5;
        var playerYspeed = 5;

        //player 2
        var player2Xpos = 0;
        var player2Ypos = 0;
        const PLAYER2_SIZE = 40;
        var player2Xspeed = 3.5;
        var player2Yspeed = 5;

        //physics
        var gravity = 0.1;
        var gravity2 = 0.1;
        var ballGravity = 0.2;
        var bounce = 0.6;
        var friction = 0.1;
        var jumpForce = -30;
        var jumping = false;
        var jumping2 = false;
        var kickspeed = 5;

        var playerCollision = false;
        var player2Collision = false;

        //ground variables
        var groundYpos = 0;
        var groundXpos = 0;
        var groundWidth = 0;
        var groundLength = 0;

        //ball speeds
        var ballXspeed = 4;
        var ballYspeed = 1;

        //controls for players

        //player 1
        const A_KEY = 65;
        const D_KEY = 68;
        const W_KEY = 87;
        const S_KEY = 83;
        var aKeyPressed = false;
        var dKeyPressed = false;
        var wKeyPressed = false;
        var sKeyPressed = false;

        //player 2
        const LEFT_KEY = 37;
        const RIGHT_KEY = 39;
        const UP_KEY = 38;
        const DOWN_KEY = 40;
        var leftKeyPressed = false;
        var rightKeyPressed = false;
        var upKeyPressed = false;
        var downKeyPressed = false;

        var startingPos = true;
        var mainMenu = false;
        var gameStart = true;

        function mainloop() {
            colorRect(0, 0, canvas.width, canvas.height, 'black'); // bg
//            drawMenuScreen(imageAssets.menuScreen,0,0, canvas.width, canvas.height);

            if (startingPos) { //starting position
                startPos();
                startingPos = false;
            }
//            
//            if(gameStart == true){
//                drawMenuScreen();
//            } else {
//                gameStart = false;
//            }

            gameSetup();

            drawGround();
            drawBall();
            drawPlayer();
            drawPlayer2();
//            drawMenuScreen();

            playerGravity();
            player2Gravity();

            playerCollisions();

            playerMove();
            player2Move();
            playerJump();
            player2Jump();

            ballCollisions();
            ballMove();

        } //end of mainloop

        function gameSetup() {
            groundLength = canvas.width;
            groundYpos = canvas.height - 80;
        } //end function

        function startPos() { //starting positions for game variables
            playerXpos = canvas.width / 7 - PLAYER_SIZE / 2;
            playerYpos = canvas.height / 1.225 - PLAYER_SIZE / 2;
            player2Xpos = canvas.width / 1.2 - PLAYER2_SIZE / 2;
            player2Ypos = canvas.height / 1.225 - PLAYER2_SIZE / 2;
        } //end of function
        
        function loadImages() {
            imgs = [];
            imgs.menuScreen = new Image();
            imgs.menuScreen.src = 'img/menuScreen.png';
            return imgs;
        }

        function ballMove() {
            ball.x += ballXspeed; //x speed
            ball.y += ballYspeed; //y spped
            ballYspeed += ballGravity; //apply gravity to ball y speed

            if (ball.y + ball.radius > groundYpos) { //if the ball is greater than the ground floor
                ball.y = groundYpos - ball.radius; //reposition on the ground
                ballYspeed *= -bounce; //bounce the ball

                if (ballYspeed < 0 && ballYspeed > -2.2) { //do this otherwise, ball never stops bouncing
                    ballYspeed = 0;
                }
                ballFriction(); //apply friction
            }
            if (ball.x > canvas.width - ball.radius && ballXspeed > 0) { //right edge bounce
                ballXspeed *= -1;
            }
            if (ball.x < 0 + ball.radius && ballXspeed < 0) { //left edge bounce
                ballXspeed *= -1;
            }
        } //end of ballMove

        function ballFriction() {
            if (Math.abs(ballXspeed) > 1.5) { //apply friction if ball speed is bigger than this
                if (ballXspeed > 0) {
                    ballXspeed = ballXspeed - friction;
                }
                if (ballXspeed < 0) {
                    ballXspeed = ballXspeed + friction //*** fix this 
                }
            }
        } //end of ballFriction

        function ballCollisions() {
            if (ball.x - ball.radius <= playerXpos + PLAYER_SIZE && ball.x + ball.radius >= playerXpos && ball.y <= playerYpos + PLAYER_SIZE && ball.y + ball.radius >= playerYpos) { //player1 hitbox with ball
                if (playerCollision == false) {

                    if (dKeyPressed == false && aKeyPressed == false) {
                        ballXspeed *= -1;
                    } else {

                        if (ball.x < playerXpos + PLAYER_SIZE / 2) {
                            ballXspeed = -kickspeed; //fix this *********
                        }
                        if (ball.x >= playerXpos + PLAYER_SIZE / 2) {
                            ballXspeed = kickspeed;
                        } //if ball inside player it will go outwards in the right direction
                    }
                }
                ballYspeed = gravity / 5 - 2; //how high the ball goes when player hits it in the y direction
                playerCollision = true;
                player2Collision = false;
            } else {
                playerCollision = false;
            } //end of player 1 collisions with ball

            if (ball.x - ball.radius <= player2Xpos + PLAYER2_SIZE && ball.x + ball.radius >= player2Xpos && ball.y <= player2Ypos + PLAYER2_SIZE && ball.y + ball.radius >= player2Ypos) { //player 2

                if (player2Collision == false) {

                    if (rightKeyPressed == false && leftKeyPressed == false) {
                        ballXspeed *= -1;
                    } else {
                        if (ball.x < player2Xpos + PLAYER2_SIZE / 2) {
                            ballXspeed = -kickspeed;
                        }
                        if (ball.x >= player2Xpos + PLAYER2_SIZE / 2) {
                            ballXspeed = kickspeed;
                        } //if ball inside player it will go outwards in the right direction
                    }
                }
                ballYspeed = gravity2 / 5 - 1;
                player2Collision = true;
                playerCollision = false;
            } else {
                player2Collision = false;
            } //end of player 2 collisions with ball

        } //end function

        function playerCollisions() {
            if (playerXpos + PLAYER_SIZE >= player2Xpos && playerXpos < player2Xpos + PLAYER2_SIZE && playerYpos + PLAYER_SIZE >= player2Ypos) {

                playerCollision = true;
            }

            if (playerXpos + PLAYER_SIZE >= player2Xpos && playerXpos < player2Xpos + PLAYER2_SIZE && player2Ypos + PLAYER2_SIZE >= playerYpos) {


                player2Collision = true;
            }
        } //end of playerCollisions

        function playerMove() {
            var left = false;
            var right = false;
            if (dKeyPressed && playerXpos < canvas.width - PLAYER_SIZE && playerCollision == false) { //move right if not outside canvas and not collding with anything
                playerXpos += playerXspeed; // x move right
                right = true;
            } else if ((playerXpos + (PLAYER_SIZE / 2)) < (player2Xpos + (PLAYER2_SIZE / 2)) && aKeyPressed && playerXpos > 0) { // player can move left if player 2 is on right side
                playerXpos -= playerXspeed; // x move left
                left = true;
            }
            if (aKeyPressed && playerXpos > 0 && playerCollision == false && left == false) {
                playerXpos -= playerXspeed; // x move left
            } else if ((playerXpos + (PLAYER_SIZE / 2)) > (player2Xpos + (PLAYER2_SIZE / 2)) && dKeyPressed && playerXpos < canvas.width - PLAYER_SIZE && right == false) { //player can move right if player 2 is on left
                playerXpos += playerXspeed; // x move right
            }
        } //end of playerMove

        function player2Move() {
            var left = false;
            var right = false;
            if (rightKeyPressed && player2Xpos < canvas.width - PLAYER2_SIZE && player2Collision == false) { //move right if not outside canvas and not collding with anything
                player2Xpos += player2Xspeed; // x move right
                right = true;
            } else if ((playerXpos + (PLAYER_SIZE / 2)) > (player2Xpos + (PLAYER2_SIZE / 2)) && leftKeyPressed && player2Xpos > 0) { // player can move left if player 2 is on right side
                player2Xpos -= player2Xspeed; // x move left
                left = true;
            }
            if (leftKeyPressed && player2Xpos > 0 && player2Collision == false && left == false) {
                player2Xpos -= player2Xspeed; // x move left
            } else if ((playerXpos + (PLAYER_SIZE / 2)) < (player2Xpos + (PLAYER2_SIZE / 2)) && rightKeyPressed && player2Xpos < canvas.width - PLAYER2_SIZE && right == false) { //player can move right if player 2 is on left
                player2Xpos += player2Xspeed; // x move right
            }
        } //end of player2Move

        function playerGravity() {
            if (gravity > -60 && playerYpos < groundYpos - PLAYER_SIZE) {
                playerYpos += gravity / 5;
                gravity += 2;
            }
        } //end of gravity

        function player2Gravity() {
            if (gravity2 > -60 && player2Ypos < groundYpos - PLAYER2_SIZE) {
                player2Ypos += gravity2 / 5;
                gravity2 += 2;
            }
        } //end of gravity2

        function playerJump() {
            if (wKeyPressed && jumping == false) {
                jumping = true;
                gravity = jumpForce; //jump speed
                playerYpos += gravity;
            }
            if (playerYpos + PLAYER_SIZE >= groundYpos) { //cannot jump more if player xpos is greater than the ground line
                playerYSpeed = 0;
                playerYpos = groundYpos - PLAYER_SIZE; //to stop player sinking through the ground
                jumping = false;
                gravity = 0;
            }
        } //end of playerJump

        function player2Jump() {
            if (upKeyPressed && jumping2 == false) {
                jumping2 = true;
                gravity2 = jumpForce; //jump force speed
                player2Ypos += gravity2;
            }
            if (player2Ypos + PLAYER2_SIZE >= groundYpos) { //cannot jump more if player xpos is greater than the horizon line
                player2YSpeed = 0;
                player2Ypos = groundYpos - PLAYER2_SIZE; //to stop player sinking through horizonYpos
                jumping2 = false;
                gravity2 = 0;
            }
        } //end of player2Jump

        function keyPressed(evt) {
            if (evt.keyCode == LEFT_KEY) {
                leftKeyPressed = true;
            }
            if (evt.keyCode == RIGHT_KEY) {
                rightKeyPressed = true;
            }
            if (evt.keyCode == UP_KEY) {
                upKeyPressed = true;
            }
            if (evt.keyCode == DOWN_KEY) {
                downKeyPressed = true;
            }

            if (evt.keyCode == A_KEY) {
                aKeyPressed = true;
            }
            if (evt.keyCode == D_KEY) {
                dKeyPressed = true;
            }
            if (evt.keyCode == W_KEY) {
                wKeyPressed = true;
            }
            if (evt.keyCode == S_KEY) {
                sKeyPressed = true;
            }
        } //end function

        function keyReleased(evt) {
            if (evt.keyCode == LEFT_KEY) {
                leftKeyPressed = false;
            }
            if (evt.keyCode == RIGHT_KEY) {
                rightKeyPressed = false;
            }
            if (evt.keyCode == UP_KEY) {
                upKeyPressed = false;
            }
            if (evt.keyCode == DOWN_KEY) {
                downKeyPressed = false;
            }

            if (evt.keyCode == A_KEY) {
                aKeyPressed = false;
            }
            if (evt.keyCode == D_KEY) {
                dKeyPressed = false;
            }
            if (evt.keyCode == W_KEY) {
                wKeyPressed = false;
            }
            if (evt.keyCode == S_KEY) {
                sKeyPressed = false;
            }
        } //end function

        function colorRect(x, y, w, h, c) {
            ctx.fillStyle = c;
            ctx.fillRect(x, y, w, h);
        } //end of colorRect

        function drawPlayer(x, y, w, h, c) {
            ctx.fillStyle = 'red';
            ctx.fillRect(playerXpos, playerYpos, PLAYER_SIZE, PLAYER_SIZE);
        } //end of drawPlayer

        function drawPlayer2(x, y, w, h, c) {
            ctx.fillStyle = 'blue';
            ctx.fillRect(player2Xpos, player2Ypos, PLAYER2_SIZE, PLAYER2_SIZE);
        } //end of function drawPlayer2

        function drawGround(x, y, w, h, c) {
            ctx.fillStyle = 'green';
            ctx.fillRect(groundXpos, groundYpos, groundLength, groundLength);
        } //end of drawGround

        function drawBall(x, y, w, h, c) {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            ctx.closePath();
        } //end of drawBall
        
//        function drawMenuScreen(src,x,y,w,h){
//            ctx.drawImage(src,x,y,w,h);
//        }

    </script>

</body>
